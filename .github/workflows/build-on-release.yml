name: Build and Package Submodules on Release

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  ##########################################
  # 1. Extract version from main repository
  ##########################################
  extract_main_version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
    steps:
      - name: üì¶ Checkout main repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üè∑ Extract version from main commit
        id: extract
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          VERSION=$(echo "$COMMIT_MSG" | grep -oP 'Release:\s*\K[^\s]+' || true)
          echo "Commit message: $COMMIT_MSG"
          echo "Extracted version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  ##########################################
  # 2. Extract version from submodules
  ##########################################
  extract_submodule_version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
    steps:
      - name: üì¶ Checkout repo with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: üè∑ Extract version from submodule commits
        id: extract
        run: |
          FOUND_VERSION=""
          for module in $(git config --file .gitmodules --get-regexp path | awk '{ print $2 }'); do
            pushd $module > /dev/null
            COMMIT_MSG=$(git log -1 --pretty=%B)
            VERSION=$(echo "$COMMIT_MSG" | grep -oP 'Release:\s*\K[^\s]+' || true)
            if [ -n "$VERSION" ]; then
              FOUND_VERSION=$VERSION
              break
            fi
            popd > /dev/null
          done
          echo "Submodule version: $FOUND_VERSION"
          echo "version=$FOUND_VERSION" >> $GITHUB_OUTPUT

  ##########################################
  # 3. Validate versions
  ##########################################
  validate:
    runs-on: ubuntu-latest
    needs: [extract_main_version, extract_submodule_version]
    steps:
      - name: ‚úÖ Validate main and submodule versions
        run: |
          MAIN_VERSION="${{ needs.extract_main_version.outputs.version }}"
          SUB_VERSION="${{ needs.extract_submodule_version.outputs.version }}"

          echo "Main version: $MAIN_VERSION"
          echo "Submodule version: $SUB_VERSION"

          if [ -z "$MAIN_VERSION" ] || [ -z "$SUB_VERSION" ]; then
            echo "‚ùå Missing version. Exiting."
            exit 1
          fi

          if [ "$MAIN_VERSION" != "$SUB_VERSION" ]; then
            echo "‚ùå Version mismatch: $MAIN_VERSION != $SUB_VERSION"
            exit 1
          fi

          echo "‚úÖ Versions matched: $MAIN_VERSION"

  ##########################################
  # 4. Build submodules
  ##########################################
  build:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: üì¶ Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: üõ† Build submodules
        run: |
          for module in $(git config --file .gitmodules --get-regexp path | awk '{ print $2 }'); do
            echo "Building $module..."
            pushd $module > /dev/null
            chmod +x ./build-and-install.sh
            ./build-and-install.sh
            popd > /dev/null
          done

  ##########################################
  # 5. Upload artifacts
  ##########################################
  upload_artifacts:
    runs-on: ubuntu-latest
    needs: [extract_main_version, build]
    steps:
      - name: üì¶ Checkout again to access files
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: üìÅ Collect versioned artifacts
        run: |
          VERSION="${{ needs.extract_main_version.outputs.version }}"
          mkdir -p artifacts
          for module in $(git config --file .gitmodules --get-regexp path | awk '{ print $2 }'); do
            DIST_PATH="$module/dist"
            DEST="artifacts/${module}-${VERSION}"
            if [ -d "$DIST_PATH" ]; then
              mkdir -p "$DEST"
              cp -r $DIST_PATH/* "$DEST/"
              echo "‚úÖ Copied $DIST_PATH to $DEST"
            else
              echo "‚ö†Ô∏è No dist/ found in $module"
            fi
          done

      - name: ‚¨ÜÔ∏è Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ needs.extract_main_version.outputs.version }}
          path: artifacts
